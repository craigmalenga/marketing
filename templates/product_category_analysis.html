{% extends "base.html" %}

{% block title %}Product Category Analysis - Marketing Analytics{% endblock %}

{% block extra_head %}
<style>
    .category-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #18124C;
    }
    
    .metric-label {
        font-size: 0.875rem;
        color: #666;
        margin-bottom: 4px;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }
    
    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .insight-card {
        background: #f8f9fa;
        border-left: 4px solid #3BF7CA;
        padding: 20px;
        border-radius: 4px;
    }
    
    .insight-title {
        font-weight: 700;
        color: #18124C;
        margin-bottom: 8px;
    }
    
    .insight-value {
        font-size: 1.25rem;
        color: #3BF7CA;
        font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <div class="page-header">
            <h1>Product Category Analysis by Campaign</h1>
            <p class="subtitle">See what product mix each campaign category produces</p>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="filters-container">
                <div class="filter-group">
                    <label for="start-date">Start Date</label>
                    <input type="date" id="start-date" class="form-control">
                </div>
                <div class="filter-group">
                    <label for="end-date">End Date</label>
                    <input type="date" id="end-date" class="form-control">
                </div>
                <div class="filter-group">
                    <label for="campaign-type">Campaign Type</label>
                    <select id="campaign-type" class="form-control">
                        <option value="">All Campaign Types</option>
                        <option value="TV">TV</option>
                        <option value="Sofa">Sofa</option>
                        <option value="Outdoor">Outdoor</option>
                        <option value="Appliance">Appliance</option>
                        <option value="Gaming">Gaming</option>
                        <option value="Credit">Credit</option>
                        <option value="Testing">Testing</option>
                        <option value="General">General</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button id="apply-filters" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button id="reset-filters" class="btn btn-secondary">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <button id="export-report" class="btn btn-success">
                    <i class="fas fa-download"></i> Export to Excel
                </button>
            </div>
        </div>

        <!-- Key Insights -->
        <div class="insights-grid" id="insights-container">
            <!-- Insights will be populated by JavaScript -->
        </div>

        <!-- Campaign Category Summary -->
        <div class="category-card">
            <h2>Campaign Category Summary</h2>
            <div class="table-responsive">
                <table class="data-table" id="category-summary-table">
                    <thead>
                        <tr>
                            <th>Campaign Category</th>
                            <th class="text-right">Total Enquiries</th>
                            <th class="text-right">TV</th>
                            <th class="text-right">Sofas</th>
                            <th class="text-right">Appliances</th>
                            <th class="text-right">Electronics</th>
                            <th class="text-right">Furniture</th>
                            <th class="text-right">Other</th>
                        </tr>
                    </thead>
                    <tbody id="category-summary-tbody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Product Distribution Chart -->
        <div class="category-card">
            <h2>Product Distribution by Campaign Category</h2>
            <div class="chart-container">
                <canvas id="distribution-chart"></canvas>
            </div>
        </div>

        <!-- Detailed Campaign Breakdown -->
        <div class="category-card">
            <h2>Detailed Product Breakdown by Campaign</h2>
            <div class="table-responsive">
                <table class="data-table" id="detailed-breakdown-table">
                    <thead>
                        <tr>
                            <th>Campaign Name</th>
                            <th class="text-right">Total Enquiries</th>
                            <th>Primary Product</th>
                            <th class="text-right">Primary %</th>
                            <th>Secondary Product</th>
                            <th class="text-right">Secondary %</th>
                            <th class="text-right">Product Mix Ratio</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-breakdown-tbody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Loading Indicator -->
<div id="loading-indicator" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <p>Loading analysis...</p>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let distributionChart = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set default date range (last 30 days)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
    
    // Load initial data
    loadProductCategoryAnalysis();
    
    // Bind event handlers
    document.getElementById('apply-filters').addEventListener('click', loadProductCategoryAnalysis);
    document.getElementById('reset-filters').addEventListener('click', resetFilters);
    document.getElementById('export-report').addEventListener('click', exportReport);
});

function loadProductCategoryAnalysis() {
    // Show loading indicator
    document.getElementById('loading-indicator').style.display = 'flex';
    
    // Get filter values
    const params = new URLSearchParams({
        start_date: document.getElementById('start-date').value,
        end_date: document.getElementById('end-date').value,
        campaign_type: document.getElementById('campaign-type').value
    });
    
    fetch(`/api/reports/product-category-analysis?${params}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading-indicator').style.display = 'none';
            
            if (data.success) {
                displayInsights(data.insights);
                displayCategorySummary(data.summary);
                displayDetailedBreakdown(data.detailed);
                updateDistributionChart(data.chartData.distribution);
            } else {
                showAlert('Failed to load analysis', 'error');
            }
        })
        .catch(error => {
            document.getElementById('loading-indicator').style.display = 'none';
            console.error('Error loading analysis:', error);
            showAlert('Error loading analysis', 'error');
        });
}

function displayInsights(insights) {
    const container = document.getElementById('insights-container');
    
    if (!insights || insights.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No insights available. Upload FLG data to see analysis.</div>';
        return;
    }
    
    let html = '';
    insights.forEach(insight => {
        html += `
            <div class="insight-card">
                <div class="insight-title">${insight.title}</div>
                <div class="insight-description">${insight.description}</div>
                <div class="insight-value">${insight.value}</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function displayCategorySummary(summary) {
    const tbody = document.getElementById('category-summary-tbody');
    
    if (!summary || summary.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No data available</td></tr>';
        return;
    }
    
    let html = '';
    summary.forEach(row => {
        html += `
            <tr>
                <td>${row.category}</td>
                <td class="text-right">${formatNumber(row.totalEnquiries)}</td>
                <td class="text-right">${formatNumber(row.tv)} (${row.tvPct}%)</td>
                <td class="text-right">${formatNumber(row.sofas)} (${row.sofasPct}%)</td>
                <td class="text-right">${formatNumber(row.appliances)} (${row.appliancesPct}%)</td>
                <td class="text-right">${formatNumber(row.electronics)} (${row.electronicsPct}%)</td>
                <td class="text-right">${formatNumber(row.furniture)} (${row.furniturePct}%)</td>
                <td class="text-right">${formatNumber(row.other)} (${row.otherPct}%)</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function displayDetailedBreakdown(detailed) {
    const tbody = document.getElementById('detailed-breakdown-tbody');
    
    if (!detailed || detailed.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No data available</td></tr>';
        return;
    }
    
    let html = '';
    detailed.forEach(row => {
        html += `
            <tr>
                <td>${row.campaignName}</td>
                <td class="text-right">${formatNumber(row.totalEnquiries)}</td>
                <td>${row.primaryProduct}</td>
                <td class="text-right">${row.primaryPct}%</td>
                <td>${row.secondaryProduct}</td>
                <td class="text-right">${row.secondaryPct}%</td>
                <td class="text-right">${row.productMixRatio}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function updateDistributionChart(chartData) {
    const ctx = document.getElementById('distribution-chart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (distributionChart) {
        distributionChart.destroy();
    }
    
    distributionChart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                title: {
                    display: false
                }
            }
        }
    });
}

function resetFilters() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
    document.getElementById('campaign-type').value = '';
    
    loadProductCategoryAnalysis();
}

function exportReport() {
    const params = {
        start_date: document.getElementById('start-date').value,
        end_date: document.getElementById('end-date').value,
        campaign_type: document.getElementById('campaign-type').value
    };
    
    fetch('/api/reports/export/product-category-analysis', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(params)
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `product_category_analysis_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showAlert('Report exported successfully', 'success');
    })
    .catch(error => {
        console.error('Error exporting report:', error);
        showAlert('Error exporting report', 'error');
    });
}
</script>
{% endblock %}