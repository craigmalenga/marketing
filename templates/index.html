{% extends "base.html" %}

{% block title %}Dashboard - Marketing Analytics Platform{% endblock %}

{% block content %}
<!-- HERO -->
<section class="hero">
    <div class="info-box">
        <h2>Marketing Analytics Dashboard</h2>
        <p>Real-time insights into campaign performance, credit applications, and ROI metrics. Make data-driven decisions to optimize your marketing spend.</p>
    </div>
</section>

<!-- Summary Cards -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-label">Total Enquiries</div>
        <div class="metric-value" id="total-enquiries">-</div>
        <div style="color: var(--primary-cyan); font-size: 0.9rem;">
            <i class="fas fa-arrow-up"></i>
            <span id="week-enquiries">-</span> this week
        </div>
    </div>

    <div class="metric-card">
        <div class="metric-label">Applications</div>
        <div class="metric-value positive" id="total-applications">-</div>
        <div style="color: var(--primary-cyan); font-size: 0.9rem;">
            <i class="fas fa-arrow-up"></i>
            <span id="week-applications">-</span> this week
        </div>
    </div>

    <div class="metric-card">
        <div class="metric-label">Approval Rate</div>
        <div class="metric-value" id="approval-rate">-</div>
        <div style="color: #666; font-size: 0.9rem;">Overall average</div>
    </div>

    <div class="metric-card">
        <div class="metric-label">Weekly Spend</div>
        <div class="metric-value" id="week-spend">-</div>
        <div style="color: #666; font-size: 0.9rem;">Marketing budget</div>
    </div>
</div>

<!-- Charts Section -->
<div class="card">
    <h3>Performance Trends</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <div>
            <h4>Weekly Trends</h4>
            <div class="chart-container">
                <canvas id="weekly-trends-chart"></canvas>
            </div>
        </div>
        <div>
            <h4>Top Products by Applications</h4>
            <div class="chart-container">
                <canvas id="product-performance-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Upload Status -->
<div class="card">
    <h3>Data Upload Status</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
        <div style="background: #f9f9f9; padding: 16px; border-radius: 4px;">
            <h4 style="margin: 0 0 8px; color: var(--primary-navy);">Applications Data</h4>
            <p style="margin: 4px 0; font-size: 0.9rem;">Last upload: <span id="applications-last-upload" style="font-weight: 700;">Not uploaded</span></p>
            <p style="margin: 4px 0; font-size: 0.9rem;">Total records: <span id="applications-total" style="font-weight: 700;">0</span></p>
        </div>
        <div style="background: #f9f9f9; padding: 16px; border-radius: 4px;">
            <h4 style="margin: 0 0 8px; color: var(--primary-navy);">FLG Data</h4>
            <p style="margin: 4px 0; font-size: 0.9rem;">Last upload: <span id="flg-last-upload" style="font-weight: 700;">Not uploaded</span></p>
            <p style="margin: 4px 0; font-size: 0.9rem;">Total records: <span id="flg-total" style="font-weight: 700;">0</span></p>
        </div>
        <div style="background: #f9f9f9; padding: 16px; border-radius: 4px;">
            <h4 style="margin: 0 0 8px; color: var(--primary-navy);">Ad Spend Data</h4>
            <p style="margin: 4px 0; font-size: 0.9rem;">Last upload: <span id="adspend-last-upload" style="font-weight: 700;">Not uploaded</span></p>
            <p style="margin: 4px 0; font-size: 0.9rem;">Total records: <span id="adspend-total" style="font-weight: 700;">0</span></p>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <h3>Quick Actions</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: center;">
        <a href="{{ url_for('upload_page') }}" class="btn btn-success">
            <i class="fas fa-upload"></i>Upload Data
        </a>
        <a href="{{ url_for('credit_performance') }}" class="btn">
            <i class="fas fa-chart-bar"></i>View Credit Report
        </a>
        <a href="{{ url_for('marketing_campaign') }}" class="btn">
            <i class="fas fa-bullhorn"></i>Campaign Report
        </a>
        <a href="/product-category-analysis" class="btn">
            <i class="fas fa-chart-pie"></i>Product Category Analysis
        </a>
        <button class="btn btn-secondary" onclick="exportAllReports()">
            <i class="fas fa-download"></i>Export All Reports
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load dashboard data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    loadUploadStatus();
    initializeCharts();
});

function loadDashboardData() {
    fetch('/api/reports/summary')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-enquiries').textContent = data.data.total_enquiries.toLocaleString();
                document.getElementById('week-enquiries').textContent = data.data.week_enquiries.toLocaleString();
                document.getElementById('total-applications').textContent = data.data.total_applications.toLocaleString();
                document.getElementById('week-applications').textContent = data.data.week_applications.toLocaleString();
                document.getElementById('approval-rate').textContent = (data.data.approval_rate * 100).toFixed(1) + '%';
                document.getElementById('week-spend').textContent = 'Â£' + data.data.week_spend.toFixed(0);
            }
        })
        .catch(error => console.error('Error loading dashboard data:', error));
}

function loadUploadStatus() {
    fetch('/api/upload/check-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Applications
                if (data.status.applications.last_upload) {
                    const date = new Date(data.status.applications.last_upload);
                    document.getElementById('applications-last-upload').textContent = date.toLocaleString('en-GB');
                }
                document.getElementById('applications-total').textContent = data.status.applications.total_records.toLocaleString();
                
                // FLG Data
                if (data.status.flg_data.last_upload) {
                    const date = new Date(data.status.flg_data.last_upload);
                    document.getElementById('flg-last-upload').textContent = date.toLocaleString('en-GB');
                }
                document.getElementById('flg-total').textContent = data.status.flg_data.total_records.toLocaleString();
                
                // Ad Spend
                if (data.status.ad_spend.last_upload) {
                    const date = new Date(data.status.ad_spend.last_upload);
                    document.getElementById('adspend-last-upload').textContent = date.toLocaleString('en-GB');
                }
                document.getElementById('adspend-total').textContent = data.status.ad_spend.total_records.toLocaleString();
            }
        })
        .catch(error => console.error('Error loading upload status:', error));
}

function initializeCharts() {
    // Weekly Trends Chart
    const trendsCtx = document.getElementById('weekly-trends-chart').getContext('2d');
    const trendsChart = new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Enquiries',
                data: [0, 0, 0, 0, 0, 0, 0],
                borderColor: '#3BF7CA',
                backgroundColor: 'rgba(59, 247, 202, 0.1)',
                tension: 0.1
            }, {
                label: 'Applications',
                data: [0, 0, 0, 0, 0, 0, 0],
                borderColor: '#18124C',
                backgroundColor: 'rgba(24, 18, 76, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Product Performance Chart
    const productCtx = document.getElementById('product-performance-chart').getContext('2d');
    const productChart = new Chart(productCtx, {
        type: 'bar',
        data: {
            labels: ['Loading...'],
            datasets: [{
                label: 'Applications',
                data: [0],
                backgroundColor: '#18124C'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function exportAllReports() {
    alert('Export functionality will be implemented in the next update.');
}
</script>
{% endblock %}
